
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://framework-x.org/docs/api/middleware/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Middleware - Framework X documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      <script async defer data-domain="framework-x.clue.engineering" src="https://plausible.io/js/plausible.js"></script>

    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#middleware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../" title="Framework X documentation" class="md-header__button md-logo" aria-label="Framework X documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Framework X documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Middleware
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/clue/framework-x/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    clue/framework-x
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Framework X documentation" class="md-nav__button md-logo" aria-label="Framework X documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Framework X documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/clue/framework-x/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    clue/framework-x
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        Quickstart in 5 minutes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/philosophy/" class="md-nav__link">
        Our philosophy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/community/" class="md-nav__link">
        Community
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Best Practices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Best Practices" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Best Practices
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/controllers/" class="md-nav__link">
        Controller classes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/deployment/" class="md-nav__link">
        Production deployment
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../app/" class="md-nav__link">
        App
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Middleware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Middleware
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inline-middleware-functions" class="md-nav__link">
    Inline middleware functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware-classes" class="md-nav__link">
    Middleware classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-middleware" class="md-nav__link">
    Request middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response-middleware" class="md-nav__link">
    Response middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-middleware" class="md-nav__link">
    Async middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#global-middleware" class="md-nav__link">
    Global middleware
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../request/" class="md-nav__link">
        Request
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../response/" class="md-nav__link">
        Response
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Async
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Async" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Async
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../async/fibers/" class="md-nav__link">
        Fibers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../async/coroutines/" class="md-nav__link">
        Coroutines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../async/promises/" class="md-nav__link">
        Promises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Integrations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Integrations" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Integrations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/database/" class="md-nav__link">
        Database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/filesystem/" class="md-nav__link">
        ⚠ Filesystem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/child-processes/" class="md-nav__link">
        ⚠ Child processes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/streaming/" class="md-nav__link">
        ⚠ Streaming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/authentication/" class="md-nav__link">
        ⚠ Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/sessions/" class="md-nav__link">
        ⚠ Sessions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/templates/" class="md-nav__link">
        ⚠ Templates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../integrations/queueing/" class="md-nav__link">
        ⚠ Queueing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inline-middleware-functions" class="md-nav__link">
    Inline middleware functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware-classes" class="md-nav__link">
    Middleware classes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-middleware" class="md-nav__link">
    Request middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response-middleware" class="md-nav__link">
    Response middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-middleware" class="md-nav__link">
    Async middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#global-middleware" class="md-nav__link">
    Global middleware
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/clue/framework-x/edit/main/docs/api/middleware.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="middleware">Middleware<a class="headerlink" href="#middleware" title="Permanent link">&para;</a></h1>
<blockquote>
<p>ℹ️ <strong>New to middleware?</strong></p>
<p>Middleware allows modifying the incoming request and outgoing response messages
and extracting this logic into reusable components.
This is frequently used for common functionality such as HTTP login, session handling, logging, and much more.</p>
</blockquote>
<h2 id="inline-middleware-functions">Inline middleware functions<a class="headerlink" href="#inline-middleware-functions" title="Permanent link">&para;</a></h2>
<p>Middleware is any piece of logic that will wrap around your request handler.
You can add any number of middleware handlers to each route.
To get started, let's take a look at a basic middleware handler
by adding an additional callable before the final controller like this:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
    <span class="s1">&#39;/user&#39;</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Psr\Http\Message\ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// optionally return response without passing to next handler</span>
        <span class="c1">// return new React\Http\Message\Response(403, [], &quot;Forbidden!\n&quot;);</span>

        <span class="c1">// optionally modify request before passing to next handler</span>
        <span class="c1">// $request = $request-&gt;withAttribute(&#39;admin&#39;, false);</span>

        <span class="c1">// call next handler in chain</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">);</span>

        <span class="c1">// optionally modify response before returning to previous handler</span>
        <span class="c1">// $response = $response-&gt;withHeader(&#39;Content-Type&#39;, &#39;text/plain&#39;);</span>

        <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Psr\Http\Message\ServerRequestInterface</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$role</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;admin&#39;</span> <span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">React\Http\Message\Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;Hello </span><span class="si">$role</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">);</span>
</code></pre></div>
<p>This example shows how you could build your own middleware that can
modifying the incoming request and outgoing response messages alike.
Each middleware is responsible for calling the next handler in the chain or directly returning an error response if the request should not be processed.</p>
<h2 id="middleware-classes">Middleware classes<a class="headerlink" href="#middleware-classes" title="Permanent link">&para;</a></h2>
<p>While inline functions are easy to get started, it's easy to see how this would become a mess once you
keep adding more controllers to a single application.
For this reason, we recommend using middleware classes for production use-cases
like this:</p>
<p><div class="highlight"><span class="filename">src/DemoMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DemoMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// optionally return response without passing to next handler</span>
        <span class="c1">// return new React\Http\Message\Response(403, [], &quot;Forbidden!\n&quot;);</span>

        <span class="c1">// optionally modify request before passing to next handler</span>
        <span class="c1">// $request = $request-&gt;withAttribute(&#39;admin&#39;, false);</span>

        <span class="c1">// call next handler in chain</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">ResponseInterface</span><span class="p">);</span>

        <span class="c1">// optionally modify response before returning to previous handler</span>
        <span class="c1">// $response = $response-&gt;withHeader(&#39;Content-Type&#39;, &#39;text/plain&#39;);</span>

        <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">public/index.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Acme\Todo\DemoMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Todo\UserController</span><span class="p">;</span>

<span class="c1">// …</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DemoMiddleware</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">());</span>
</code></pre></div></p>
<p>This highlights how middleware classes provide the exact same functionaly as using inline functions,
yet provide a cleaner and more reusable structure.
Accordingly, all examples below use middleware classes as the recommended style.</p>
<blockquote>
<p>ℹ️ <strong>New to Composer autoloading?</strong></p>
<p>This example uses namespaced classes as the recommended way
in the PHP ecosystem. If you're new to setting up your project
structure, see also <a href="../../best-practices/controllers/">controller classes</a> for more details.</p>
</blockquote>
<h2 id="request-middleware">Request middleware<a class="headerlink" href="#request-middleware" title="Permanent link">&para;</a></h2>
<p>To get started, we can add an example middleware handler that can modify the incoming request:</p>
<div class="highlight"><span class="filename">src/AdminMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AdminMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getServerParams</span><span class="p">()[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$ip</span> <span class="o">===</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">withAttribute</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">src/UserController.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Http\Message\Response</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$role</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;admin&#39;</span> <span class="o">:</span> <span class="s1">&#39;user&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;Hello </span><span class="si">$role</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="x"># public/index.php</span>
<span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Acme\Todo\AdminMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Todo\UserController</span><span class="p">;</span>

<span class="c1">// …</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">AdminMiddleware</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">());</span>
</code></pre></div>
<p>For example, an HTTP <code>GET</code> request for <code>/user</code> would first call the middleware handler which then modifies this request and passes the modified request to the next controller function.
This is commonly used for HTTP authentication, login handling and session handling.</p>
<p>Note that this example only modifies the incoming request object and simply
returns whatever the next request handler returns without modifying the outgoing
response. This means this works both when the next request handler returns a
<a href="../response/">response object</a> synchronously or if you're using an async
request handler that may return a <a href="../../async/promises/">promise</a> or
<a href="../../async/coroutines/">coroutine</a>. If you want to modify the outgoing response
object, see also the next chapter.</p>
<h2 id="response-middleware">Response middleware<a class="headerlink" href="#response-middleware" title="Permanent link">&para;</a></h2>
<p>Likewise, we can add an example middleware handler that can modify the outgoing response:</p>
<div class="highlight"><span class="filename">src/ContentTypeMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ContentTypeMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">ResponseInterface</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">src/UserController.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Http\Message\Response</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;Alice&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;Hello </span><span class="si">$name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">public/index.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Acme\Todo\ContentTypeMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Todo\UserController</span><span class="p">;</span>

<span class="c1">// …</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">ContentTypeMiddleware</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">());</span>
</code></pre></div>
<p>For example, an HTTP <code>GET</code> request for <code>/user</code> would first call the middleware handler which passes on the request to the controller function and then modifies the response that is returned by the controller function.
This is commonly used for cache handling and response body transformations (compression etc.).</p>
<p>Note that this example assumes the next request handler returns a
<a href="../response/">response object</a> synchronously. If you're writing a
middleware that also needs to support async request handlers that may
return a <a href="../../async/promises/">promise</a> or <a href="../../async/coroutines/">coroutine</a>,
see also the next chapter.</p>
<h2 id="async-middleware">Async middleware<a class="headerlink" href="#async-middleware" title="Permanent link">&para;</a></h2>
<p>One of the core features of X is its async support.
As a consequence, each middleware handler can also return
<a href="../../async/promises/">promises</a> or <a href="../../async/coroutines/">coroutines</a>.
While <a href="#request-middleware">request middleware</a> doesn't usually have to care
about async responses, this particularly affects
<a href="#response-middleware">response middleware</a> that wants to change the outgoing
response.</p>
<p>Here's an example middleware handler that can modify the outgoing response no
matter whether the next request handler returns a
<a href="../../async/promises/">promise</a>, a <a href="../../async/coroutines/">coroutine</a> or
a response object synchronously:</p>
<div class="tabbed-set" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Arrow functions (PHP 7.4+)</label><div class="tabbed-content">
<div class="highlight"><span class="filename">src/AsyncAwareContentTypeMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\PromiseInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AsyncContentTypeMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">PromiseInterface</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="nx">fn</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">\Generator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">fn</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">yield</span> <span class="nx">from</span> <span class="nv">$response</span><span class="p">))();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Match syntax (PHP 8.0+)</label><div class="tabbed-content">
<div class="highlight"><span class="filename">src/AsyncAwareContentTypeMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\PromiseInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AsyncContentTypeMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">match</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">PromiseInterface</span> <span class="o">=&gt;</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="nx">fn</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">)),</span>
            <span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">\Generator</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">fn</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">yield</span> <span class="nx">from</span> <span class="nv">$response</span><span class="p">))(),</span>
            <span class="k">default</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">),</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">Closures</label><div class="tabbed-content">
<div class="highlight"><span class="filename">src/AsyncAwareContentTypeMiddleware.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\PromiseInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AsyncContentTypeMiddleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">callable</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">PromiseInterface</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">\Generator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">yield</span> <span class="nx">from</span> <span class="nv">$response</span><span class="p">);</span>
            <span class="p">})();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
<!-- -->

<div class="tabbed-set" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Coroutines</label><div class="tabbed-content">
<div class="highlight"><span class="filename">src/AsyncUserController.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\EventLoop\Loop</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Http\Message\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\Promise</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\PromiseInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AsyncUserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">\Generator</span>
    <span class="p">{</span>
        <span class="c1">// async pseudo code to load some data from an external source</span>
        <span class="nv">$promise</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetchRandomUserName</span><span class="p">();</span>

        <span class="nv">$name</span> <span class="o">=</span> <span class="k">yield</span> <span class="nv">$promise</span><span class="p">;</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">));</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;Hello </span><span class="si">$name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @return PromiseInterface&lt;string&gt;</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">fetchRandomUserName</span><span class="p">()</span><span class="o">:</span> <span class="nx">PromiseInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$resolve</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Loop</span><span class="o">::</span><span class="na">addTimer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$resolve</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$resolve</span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Promises</label><div class="tabbed-content">
<div class="highlight"><span class="filename">src/AsyncUserController.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Todo</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\EventLoop\Loop</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Http\Message\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\Promise</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">React\Promise\PromiseInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AsyncUserController</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @return PromiseInterface&lt;Response&gt;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">(</span><span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">PromiseInterface</span>
    <span class="p">{</span>
        <span class="c1">// async pseudo code to load some data from an external source</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fetchRandomUserName</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;Hello </span><span class="si">$name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @return PromiseInterface&lt;string&gt;</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">fetchRandomUserName</span><span class="p">()</span><span class="o">:</span> <span class="nx">PromiseInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$resolve</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Loop</span><span class="o">::</span><span class="na">addTimer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$resolve</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$resolve</span><span class="p">(</span><span class="s1">&#39;Alice&#39;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
<div class="highlight"><span class="filename">public/index.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Acme\Todo\AsyncContentTypeMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Todo\AsyncUserController</span><span class="p">;</span>

<span class="c1">// …</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">AsyncContentTypeMiddleware</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">AsyncUserController</span><span class="p">());</span>
</code></pre></div>
<p>For example, an HTTP <code>GET</code> request for <code>/user</code> would first call the middleware handler which passes on the request to the controller function and then modifies the response that is returned by the controller function.
This is commonly used for cache handling and response body transformations (compression etc.).</p>
<blockquote>
<p>🔮 <strong>Future fiber support in PHP 8.1</strong></p>
<p>In the future, PHP 8.1 will provide native support for <a href="../../async/fibers/">fibers</a>.
Once fibers become mainstream, we can simplify this example significantly
because we wouldn't have to use <a href="../../async/promises/">promises</a> or
<a href="../../async/coroutines/">Generator-based coroutines</a> anymore.
See <a href="../../async/fibers/">fibers</a> for more details.</p>
</blockquote>
<h2 id="global-middleware">Global middleware<a class="headerlink" href="#global-middleware" title="Permanent link">&para;</a></h2>
<p>Additionally, you can also add middleware to the <a href="../app/"><code>App</code></a> object itself
to register a global middleware handler:</p>
<div class="highlight"><span class="filename">public/index.php</span><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Acme\Todo\AdminMiddleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Todo\UserController</span><span class="p">;</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FrameworkX\App</span><span class="p">(</span><span class="k">new</span> <span class="nx">AdminMiddleware</span><span class="p">());</span>
<span class="hll">
</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">UserController</span><span class="p">());</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">();</span>
</code></pre></div>
<p>Any global middleware handler will always be called for all registered routes
and also any requests that can not be routed.</p>
<p>You can also combine global middleware handlers (think logging) with additional
middleware handlers for individual routes (think authentication).
Global middleware handlers will always be called before route middleware handlers.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../app/" class="md-footer__link md-footer__link--prev" aria-label="Previous: App" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              App
            </div>
          </div>
        </a>
      
      
        
        <a href="../request/" class="md-footer__link md-footer__link--next" aria-label="Next: Request" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Request
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>